# 复杂分步表单开发指南

本文档是AI Agent开发复杂分步表单功能的参考模板，涵盖了从列表页到表单页的完整开发流程。

## 一、功能概述

复杂分步表单适用于字段较多、逻辑较复杂的数据录入场景，通过分步的方式降低用户认知负担，提高填写体验。

**核心特点：**
- 列表页提供数据浏览和快速操作
- 添加/编辑操作通过新标签页打开，支持同时编辑多条数据
- 表单分多个步骤，每步独立验证
- 表单状态追踪，关闭时提示未保存修改
- 提交成功后自动关闭标签页并刷新列表

## 二、目录结构

```
src/views/complex-form/
├── index.vue              # 列表页
├── form.vue               # 分步表单页
└── composables/           # 可选：复用逻辑
```

## 三、列表页开发 (index.vue)

### 3.1 基础结构

列表页包含以下核心模块：

```vue
<template>
  <div class="user-page">
    <!-- 1. 页面导航 -->
    <div class="page-header">
      <a-breadcrumb>...</a-breadcrumb>
      <a-button @click="addToQuickMenu">加入快捷菜单</a-button>
    </div>

    <a-card>
      <!-- 2. 搜索表单 -->
      <div class="search-form">...</div>

      <!-- 3. 工具栏 -->
      <div class="toolbar">...</div>

      <!-- 4. 数据表格 -->
      <a-table>...</a-table>

      <!-- 5. 分页 -->
      <div class="pagination">...</div>
    </a-card>
  </div>
</template>
```

### 3.2 关键实现：打开新标签页

**添加操作：**
```typescript
const handleAdd = () => {
  router.push('/complex-form/add')
}
```

**编辑操作：**
```typescript
const handleEdit = (record: UserQueryModel) => {
  router.push(`/complex-form/edit/${record.id}`)
}
```

**路由配置：**
```typescript
{
  path: '/complex-form/:action/:id?',
  name: 'complexFormEdit',
  component: () => import('@/views/complex-form/form.vue'),
  meta: { title: '表单编辑' }
}
```

### 3.3 快捷菜单集成

```typescript
const addToQuickMenu = () => {
  const list = JSON.parse(localStorage.getItem('quickMenus') || '[]')
  const current = { key: '/complex-form', name: '复杂分步表单' }
  
  if (list.findIndex((x: any) => x.key === current.key) >= 0) {
    Message.info('已经在快捷菜单中')
    return
  }
  
  list.unshift(current)
  while (list.length > 3) list.pop()
  
  localStorage.setItem('quickMenus', JSON.stringify(list))
  window.dispatchEvent(new Event('storage'))
  Message.success('已加入快捷菜单')
}
```

## 四、分步表单页开发 (form.vue)

### 4.1 表单结构

```vue
<template>
  <div class="form-page">
    <!-- 面包屑 -->
    <div class="page-header">...</div>

    <a-card>
      <!-- 标题 + 未保存标识 -->
      <template #title>
        <div class="card-title">
          <span>{{ pageTitle }}</span>
          <a-tag v-if="formChanged" color="orange">未保存</a-tag>
        </div>
      </template>

      <!-- 步骤条 -->
      <a-steps :current="currentStep">
        <a-step title="基础信息" />
        <a-step title="安全信息" />
        <a-step title="附加信息" />
      </a-steps>

      <!-- 表单内容 -->
      <div class="form-container">
        <a-form :model="formData" :rules="rules" ref="formRef">
          <!-- 第一步 -->
          <div v-show="currentStep === 0">...</div>
          
          <!-- 第二步 -->
          <div v-show="currentStep === 1">...</div>
          
          <!-- 第三步 -->
          <div v-show="currentStep === 2">...</div>
        </a-form>
      </div>

      <!-- 底部按钮 -->
      <div class="form-footer">
        <a-button v-if="currentStep > 0" @click="handlePrevStep">上一步</a-button>
        <a-button v-if="currentStep < 2" type="primary" @click="handleNextStep">下一步</a-button>
        <a-button v-if="currentStep === 2" type="primary" @click="handleSubmit">提交</a-button>
      </div>
    </a-card>
  </div>
</template>
```

### 4.2 页面标题动态生成

```typescript
const isAdd = computed(() => route.params.action === 'add')
const userId = computed(() => route.params.id as string)

const pageTitle = computed(() => {
  if (isAdd.value) {
    return '添加新用户'
  } else {
    return `编辑用户: ${formData.value.realName || userId.value}`
  }
})
```

### 4.3 表单状态追踪

```typescript
// 表单是否被修改
const formChanged = ref(false)

// 原始数据（用于对比）
const originalData = ref<any>(null)

// 表单变化处理
const handleFormChange = () => {
  if (!originalData.value) {
    formChanged.value = true
    return
  }
  
  formChanged.value = JSON.stringify(formData.value) !== JSON.stringify(originalData.value)
}
```

**绑定到每个表单控件：**
```vue
<a-input
  v-model="formData.username"
  @input="handleFormChange"
/>
```

### 4.4 分步验证

**下一步验证：**
```typescript
const handleNextStep = async () => {
  const fieldsToValidate = getStepFields(currentStep.value)
  try {
    const errors = await formRef.value?.validateField(fieldsToValidate)
    if (errors) return
    currentStep.value++
  } catch (error) {
    console.error('验证失败:', error)
  }
}

// 获取每步需要验证的字段
const getStepFields = (step: number): string[] => {
  const fieldMap: Record<number, string[]> = {
    0: ['username', 'realName', 'gender', 'age', 'scope', 'department', 'position'],
    1: ['email', 'phone', 'password', 'confirmPassword'],
    2: []
  }
  return fieldMap[step] || []
}
```

### 4.5 提交后关闭标签页

```typescript
const handleSubmit = async () => {
  try {
    await formRef.value?.validate()
    submitting.value = true

    if (isAdd.value) {
      await createUser(submitData)
      Message.success('添加成功')
    } else {
      await modifyUser(userId.value, submitData)
      Message.success('修改成功')
    }

    // 标记为未修改
    formChanged.value = false
    
    // 延迟关闭标签页
    setTimeout(() => {
      closeCurrentTab()
    }, 500)
  } finally {
    submitting.value = false
  }
}

const closeCurrentTab = () => {
  const tabs = JSON.parse(localStorage.getItem('tabs') || '[]')
  const currentPath = route.fullPath
  
  const currentIndex = tabs.findIndex((t: any) => t.path === currentPath)
  
  if (currentIndex >= 0) {
    tabs.splice(currentIndex, 1)
    localStorage.setItem('tabs', JSON.stringify(tabs))
    window.dispatchEvent(new Event('storage'))
    router.push('/complex-form')
  }
}
```

### 4.6 关闭前确认

**路由守卫：**
```typescript
import { onBeforeRouteLeave } from 'vue-router'

onBeforeRouteLeave((to, from, next) => {
  if (formChanged.value) {
    Modal.confirm({
      title: '提示',
      content: '当前页面信息已修改，是否关闭？',
      okText: '确定',
      cancelText: '取消',
      onOk: () => next(),
      onCancel: () => next(false)
    })
  } else {
    next()
  }
})
```

**浏览器关闭/刷新拦截：**
```typescript
const handleBeforeUnload = (e: BeforeUnloadEvent) => {
  if (formChanged.value) {
    e.preventDefault()
    e.returnValue = ''
  }
}

onMounted(() => {
  window.addEventListener('beforeunload', handleBeforeUnload)
})

onBeforeUnmount(() => {
  window.removeEventListener('beforeunload', handleBeforeUnload)
})
```

## 五、路由配置

```typescript
{
  path: '/',
  component: () => import('@/views/layout/MainLayout.vue'),
  children: [
    {
      path: '/complex-form',
      name: 'complexForm',
      component: () => import('@/views/complex-form/index.vue'),
      meta: {
        title: '复杂分步表单',
        buttons: ['user:add', 'user:modify', 'user:forbid', 'user:activate']
      }
    },
    {
      path: '/complex-form/:action/:id?',
      name: 'complexFormEdit',
      component: () => import('@/views/complex-form/form.vue'),
      meta: {
        title: '表单编辑'
      }
    }
  ]
}
```

## 六、样式规范

### 6.1 列表页样式

```scss
.user-page {
  padding: 20px;

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .content-card {
    :deep(.arco-card-header-title) {
      font-weight: 600;
      font-size: 18px;
    }
  }
}
```

### 6.2 表单页样式

```scss
.form-page {
  padding: 20px;

  .steps-bar {
    margin: 32px 0;
  }

  .form-container {
    min-height: 400px;
    padding: 24px 0;
  }

  .step-content {
    max-width: 800px;
    margin: 0 auto;
  }

  .form-footer {
    margin-top: 32px;
    padding-top: 24px;
    border-top: 1px solid #e5e6eb;
    display: flex;
    justify-content: center;
  }
}
```

## 七、API接口规范

复用已有的用户API，无需新增接口：

```typescript
import { createUser, modifyUser, getUser } from '@/api/user'

// 添加
await createUser(data)

// 修改
await modifyUser(id, data)

// 获取详情（编辑时）
await getUser(id)
```

## 八、开发检查清单

### 列表页
- [ ] 搜索表单布局统一（label宽度80px，输入框200px）
- [ ] 工具栏包含添加按钮和刷新按钮
- [ ] 操作列按钮使用规范样式（mini尺寸）
- [ ] 点击添加/编辑打开新标签页
- [ ] 实现快捷菜单功能

### 表单页
- [ ] 步骤条正确显示当前步骤
- [ ] 每步显示对应的表单字段
- [ ] 第一步：仅显示"下一步"按钮
- [ ] 中间步：显示"上一步"和"下一步"按钮
- [ ] 最后一步：显示"上一步"和"提交"按钮
- [ ] 下一步前验证当前步骤字段
- [ ] 最后一步显示信息确认摘要
- [ ] 追踪表单修改状态，显示"未保存"标识
- [ ] 关闭标签页前弹出确认（如有修改）
- [ ] 刷新/关闭浏览器前拦截（如有修改）
- [ ] 提交成功后自动关闭标签页
- [ ] 编辑模式正确加载数据
- [ ] 页面标题动态显示（添加/编辑 + 用户名）

### 路由和菜单
- [ ] 添加列表页路由
- [ ] 添加表单页路由（带action和id参数）
- [ ] 在菜单中添加入口
- [ ] 面包屑导航正确

## 九、快速改造现有CRUD

如果已有简单CRUD（使用抽屉/对话框），改造步骤：

1. **复制列表页**：保留搜索、表格、分页逻辑
2. **修改添加/编辑按钮**：从打开对话框改为路由跳转
3. **创建表单页**：实现分步表单
4. **添加路由**：配置列表页和表单页路由
5. **实现状态追踪**：添加formChanged逻辑
6. **实现关闭确认**：添加路由守卫和beforeunload监听
7. **实现自动关闭**：提交成功后关闭标签页

## 十、最佳实践

1. **步骤划分**：根据字段逻辑分组，每步5-10个字段为宜
2. **验证粒度**：每步独立验证，避免全部填完才发现第一步有错
3. **信息确认**：最后一步显示完整信息摘要，方便用户检查
4. **状态提示**：明确显示"未保存"标识，避免用户误操作
5. **友好拦截**：关闭前确认使用Modal，文案清晰明确
6. **自动关闭**：提交成功后延迟500ms再关闭，确保用户看到成功提示
7. **多标签支持**：使用路径+参数区分不同表单实例
8. **数据回显**：编辑模式正确加载原始数据并保存副本用于对比

## 十一、常见问题

**Q: 为什么要延迟关闭标签页？**
A: 立即关闭用户可能看不到成功提示，延迟500ms体验更好。

**Q: 如何支持同时编辑多个不同用户？**
A: 使用带参数的路由，每个用户ID对应不同的路径，tabs系统会创建独立标签。

**Q: 表单很长，是否需要分更多步骤？**
A: 建议3-5步为宜，过多步骤会增加操作成本。可以通过折叠面板在同一步内组织字段。

**Q: 如何在关闭标签时刷新列表？**
A: 不需要，列表页会在用户切回时自动刷新（通过watch route实现）。或者在closeCurrentTab后触发事件通知列表页刷新。

## 十二、扩展方向

- 支持保存草稿（localStorage暂存）
- 支持步骤导航（点击步骤条跳转）
- 支持条件步骤（根据前面选择动态显示后续步骤）
- 支持进度保存（关闭后下次打开恢复）
- 支持表单协作（多人同时编辑提示）

---

**参考代码位置：**
- 列表页：`src/views/complex-form/index.vue`
- 表单页：`src/views/complex-form/form.vue`
- 路由配置：`src/router/index.ts`
