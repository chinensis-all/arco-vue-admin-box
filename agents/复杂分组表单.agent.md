# 复杂分组表单开发指南

本文档是AI Agent开发复杂分组表单功能的参考模板，涵盖了从列表页到表单页的完整开发流程。

## 一、功能概述

复杂分组表单适用于字段较多、逻辑上可分类的数据录入场景，通过折叠面板的方式组织表单，提高可读性和操作效率。

**核心特点：**
- 列表页提供数据浏览和快速操作
- 添加/编辑操作通过新标签页打开，支持同时编辑多条数据
- 表单分多个分组，每组可独立展开/折叠
- 表单状态追踪，关闭时提示未保存修改
- 提交成功后自动关闭标签页并刷新列表

## 二、目录结构

```
src/views/group-form/
├── index.vue              # 列表页
└── form.vue               # 分组表单页
```

## 三、列表页开发 (index.vue)

### 3.1 基础结构

与"Restful CRUD"列表页结构相同，包含：
- 页面导航（面包屑 + 快捷菜单）
- 搜索表单
- 工具栏
- 数据表格
- 分页

### 3.2 关键实现：打开新标签页

**添加操作：**
```typescript
const handleAdd = () => {
  router.push('/group-form/add')
}
```

**编辑操作：**
```typescript
const handleEdit = (record: UserQueryModel) => {
  router.push(`/group-form/edit/${record.id}`)
}
```

**路由配置：**
```typescript
{
  path: '/group-form/:action/:id?',
  name: 'groupFormEdit',
  component: () => import('@/views/group-form/form.vue'),
  meta: { title: '表单编辑' }
}
```

## 四、分组表单页开发 (form.vue)

### 4.1 表单结构

使用 Arco Design 的 Collapse 组件实现分组：

```vue
<template>
  <div class="form-page">
    <a-card>
      <template #title>
        <div class="card-title">
          <span>{{ pageTitle }}</span>
          <a-tag v-if="formChanged" color="orange">未保存</a-tag>
        </div>
      </template>

      <a-form :model="formData" :rules="rules" ref="formRef">
        <a-collapse :default-active-key="['basic', 'security']" :bordered="false">
          <!-- 第一组：基础信息（默认展开） -->
          <a-collapse-item key="basic">
            <template #header>
              <div class="collapse-header">
                <span class="header-title">基础信息</span>
              </div>
            </template>
            <div class="group-content">
              <!-- 基础信息字段 -->
            </div>
          </a-collapse-item>

          <!-- 第二组：安全信息（默认展开） -->
          <a-collapse-item key="security">
            <template #header>
              <div class="collapse-header">
                <span class="header-title">安全信息</span>
              </div>
            </template>
            <div class="group-content">
              <!-- 安全信息字段 -->
            </div>
          </a-collapse-item>

          <!-- 第三组：附加信息（默认折叠） -->
          <a-collapse-item key="additional">
            <template #header>
              <div class="collapse-header">
                <span class="header-title">附加信息</span>
              </div>
            </template>
            <div class="group-content">
              <!-- 附加信息字段 -->
            </div>
          </a-collapse-item>
        </a-collapse>
      </a-form>

      <!-- 底部按钮 -->
      <div class="form-footer">
        <a-button @click="handleCancel">取消</a-button>
        <a-button type="primary" @click="handleSubmit">提交</a-button>
      </div>
    </a-card>
  </div>
</template>
```

### 4.2 默认展开/折叠控制

使用 `default-active-key` 属性控制默认展开的面板：

```vue
<a-collapse :default-active-key="['basic', 'security']" :bordered="false">
```

- `basic` 和 `security` 默认展开
- `additional` 默认折叠（不在数组中）
- 用户可以通过点击标题栏右侧的箭头展开/折叠

### 4.3 分组样式定制

```scss
:deep(.arco-collapse) {
  border: none;
  
  .arco-collapse-item {
    margin-bottom: 16px;
    border: 1px solid #e5e6eb;
    border-radius: 4px;
    
    &:last-child {
      margin-bottom: 0;
    }
  }
  
  .arco-collapse-item-header {
    padding: 16px 20px;
    background: #f7f8fa;
    border-bottom: 1px solid #e5e6eb;
    
    .collapse-header {
      .header-title {
        font-size: 16px;
        font-weight: 600;
        color: #1d2129;
      }
    }
  }
  
  .arco-collapse-item-content {
    padding: 0;
  }
}

.group-content {
  padding: 24px 20px;
}
```

### 4.4 表单字段分组

**第一组 - 基础信息：**
- 用户名
- 真实姓名
- 性别
- 年龄
- 用户类型
- 部门
- 职位

**第二组 - 安全信息：**
- 邮箱
- 手机号
- 密码（添加时）
- 确认密码（添加时）
- 角色

**第三组 - 附加信息：**
- 个人简介

### 4.5 表单状态追踪

```typescript
// 表单是否被修改
const formChanged = ref(false)

// 原始数据（用于对比）
const originalData = ref<any>(null)

// 表单变化处理
const handleFormChange = () => {
  if (!originalData.value) {
    formChanged.value = true
    return
  }
  
  formChanged.value = JSON.stringify(formData.value) !== JSON.stringify(originalData.value)
}
```

**绑定到每个表单控件：**
```vue
<a-input
  v-model="formData.username"
  @input="handleFormChange"
/>
```

### 4.6 取消操作

取消按钮也需要检查是否有未保存修改：

```typescript
const handleCancel = () => {
  if (formChanged.value) {
    Modal.confirm({
      title: '提示',
      content: '当前页面信息已修改，是否关闭？',
      okText: '确定',
      cancelText: '取消',
      onOk: () => {
        closeCurrentTab()
      }
    })
  } else {
    closeCurrentTab()
  }
}
```

### 4.7 提交后关闭标签页

```typescript
const handleSubmit = async () => {
  try {
    await formRef.value?.validate()
    submitting.value = true

    if (isAdd.value) {
      await createUser(submitData)
      Message.success('添加成功')
    } else {
      await modifyUser(userId.value, submitData)
      Message.success('修改成功')
    }

    // 标记为未修改
    formChanged.value = false
    
    // 延迟关闭标签页
    setTimeout(() => {
      closeCurrentTab()
    }, 500)
  } finally {
    submitting.value = false
  }
}

const closeCurrentTab = () => {
  const tabs = JSON.parse(localStorage.getItem('tabs') || '[]')
  const currentPath = route.fullPath
  
  const currentIndex = tabs.findIndex((t: any) => t.path === currentPath)
  
  if (currentIndex >= 0) {
    tabs.splice(currentIndex, 1)
    localStorage.setItem('tabs', JSON.stringify(tabs))
    window.dispatchEvent(new Event('storage'))
    router.push('/group-form')
  }
}
```

### 4.8 关闭前确认

**路由守卫：**
```typescript
import { onBeforeRouteLeave } from 'vue-router'

onBeforeRouteLeave((to, from, next) => {
  if (formChanged.value) {
    Modal.confirm({
      title: '提示',
      content: '当前页面信息已修改，是否关闭？',
      okText: '确定',
      cancelText: '取消',
      onOk: () => next(),
      onCancel: () => next(false)
    })
  } else {
    next()
  }
})
```

**浏览器关闭/刷新拦截：**
```typescript
const handleBeforeUnload = (e: BeforeUnloadEvent) => {
  if (formChanged.value) {
    e.preventDefault()
    e.returnValue = ''
  }
}

onMounted(() => {
  window.addEventListener('beforeunload', handleBeforeUnload)
})

onBeforeUnmount(() => {
  window.removeEventListener('beforeunload', handleBeforeUnload)
})
```

## 五、路由配置

```typescript
{
  path: '/',
  component: () => import('@/views/layout/MainLayout.vue'),
  children: [
    {
      path: '/group-form',
      name: 'groupForm',
      component: () => import('@/views/group-form/index.vue'),
      meta: {
        title: '复杂分组表单',
        buttons: ['user:add', 'user:modify', 'user:forbid', 'user:activate']
      }
    },
    {
      path: '/group-form/:action/:id?',
      name: 'groupFormEdit',
      component: () => import('@/views/group-form/form.vue'),
      meta: {
        title: '表单编辑'
      }
    }
  ]
}
```

**router.afterEach 动态标题：**
```typescript
if (to.name === 'groupFormEdit') {
  if (to.params.action === 'add') {
    title = '添加新用户';
  } else if (to.params.action === 'edit') {
    title = `编辑用户: ${to.params.id}`;
  }
}
```

## 六、样式规范

### 6.1 表单页整体布局

```scss
.form-page {
  padding: 20px;

  .form-card {
    .card-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      font-weight: 600;
    }

    .form-container {
      padding: 24px 0;
    }

    .form-footer {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid #e5e6eb;
      display: flex;
      justify-content: center;
    }
  }
}
```

### 6.2 折叠面板样式

- 去除默认边框（`:bordered="false"`）
- 每个面板添加自定义边框和圆角
- 标题栏使用浅灰色背景（`#f7f8fa`）
- 内容区域添加内边距（`24px 20px`）
- 面板之间间距 `16px`

## 七、开发检查清单

### 列表页
- [ ] 搜索表单布局统一
- [ ] 工具栏包含添加和刷新按钮
- [ ] 操作列按钮使用规范样式
- [ ] 点击添加/编辑打开新标签页
- [ ] 实现快捷菜单功能

### 表单页
- [ ] 使用 Collapse 组件实现分组
- [ ] 第一组和第二组默认展开
- [ ] 第三组默认折叠
- [ ] 每组标题栏样式统一
- [ ] 每组内容有合适的内边距
- [ ] 底部有取消和提交按钮
- [ ] 追踪表单修改状态，显示"未保存"标识
- [ ] 取消按钮点击时确认（如有修改）
- [ ] 关闭标签页前弹出确认（如有修改）
- [ ] 刷新/关闭浏览器前拦截（如有修改）
- [ ] 提交成功后自动关闭标签页
- [ ] 编辑模式正确加载数据
- [ ] 页面标题动态显示

### 路由和菜单
- [ ] 添加列表页路由
- [ ] 添加表单页路由（带action和id参数）
- [ ] 在菜单中添加入口
- [ ] 面包屑导航正确
- [ ] 动态标题配置正确

## 八、与分步表单的区别

| 特性 | 分步表单 | 分组表单 |
|------|---------|---------|
| 适用场景 | 流程性强，需要引导填写 | 字段分类明确，无固定顺序 |
| 导航方式 | 步骤条，线性导航 | 折叠面板，自由展开 |
| 验证时机 | 每步验证后才能下一步 | 提交时统一验证 |
| 页面元素 | 步骤条 + 上一步/下一步按钮 | 折叠面板 + 取消/提交按钮 |
| 视觉呈现 | 一次只显示一步内容 | 所有分组依次排列 |
| 用户体验 | 引导性强，适合新手 | 自由度高，适合熟悉用户 |

## 九、快速改造现有CRUD

如果已有简单CRUD（使用抽屉/对话框），改造步骤：

1. **复制列表页**：保留搜索、表格、分页逻辑
2. **修改添加/编辑按钮**：从打开对话框改为路由跳转
3. **创建表单页**：实现分组表单
4. **添加路由**：配置列表页和表单页路由
5. **实现状态追踪**：添加formChanged逻辑
6. **实现关闭确认**：添加路由守卫和beforeunload监听
7. **实现自动关闭**：提交成功后关闭标签页

## 十、最佳实践

1. **分组原则**：按业务逻辑分组，每组3-8个字段为宜
2. **默认展开**：常用信息默认展开，辅助信息默认折叠
3. **标题清晰**：分组标题使用名词短语，简洁明了
4. **视觉层次**：使用标题栏背景色区分分组
5. **统一验证**：提交时统一验证，不需要分组验证
6. **状态提示**：明确显示"未保存"标识
7. **取消确认**：取消和关闭都需要确认（如有修改）
8. **自动关闭**：提交成功后延迟500ms再关闭

## 十一、常见问题

**Q: 如何添加更多分组？**
A: 在 Collapse 中添加新的 `a-collapse-item`，设置唯一的 `key`，并决定是否加入 `default-active-key`。

**Q: 如何控制某个分组不可折叠？**
A: 使用 `:disabled="true"` 属性，或者不使用 Collapse，直接用普通的分组容器。

**Q: 分组顺序是否可以调整？**
A: 可以，直接调整 `a-collapse-item` 的顺序即可。

**Q: 如何在标题栏添加额外操作？**
A: 在 header 插槽中添加自定义内容，注意使用 `@click.stop` 阻止事件冒泡。

**Q: 所有分组都展开时页面太长怎么办？**
A: 可以限制表单容器的最大高度，添加滚动条；或者调整默认展开策略，让用户按需展开。

## 十二、扩展方向

- 支持分组标题右侧显示字段数量或完成状态
- 支持分组拖拽排序（个性化布局）
- 支持分组条件显示（根据前面字段值动态显示）
- 支持分组独立保存（保存草稿）
- 支持分组级别的验证状态显示
- 支持快速定位到第一个错误分组

---

**参考代码位置：**
- 列表页：`src/views/group-form/index.vue`
- 表单页：`src/views/group-form/form.vue`
- 路由配置：`src/router/index.ts`
